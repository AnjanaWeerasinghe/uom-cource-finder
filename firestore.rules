rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to get user's role from users collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isSignedIn() && getUserRole() == "admin";
    }
    
    // Helper function to check if user is teacher
    function isTeacher() {
      return isSignedIn() && getUserRole() == "teacher";
    }
    
    // Helper function to check if user is student
    function isStudent() {
      return isSignedIn() && getUserRole() == "student";
    }
    
    // Courses collection
    match /courses/{courseId} {
      // Anyone can read courses
      allow read: if true;
      
      // Only admin can create, update, or delete courses
      allow create, update, delete: if isAdmin();
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isSignedIn() && request.auth.uid == userId;
      
      // Users can create their own document (during signup)
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Users can update their own document except the role field
      allow update: if isSignedIn() && request.auth.uid == userId 
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      
      // Admin can read all users
      allow read: if isAdmin();
      
      // Admin can update any user's role
      allow update: if isAdmin();
      
      // Subcollections for user-specific data
      match /favourites/{favId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
      
      match /enrollments/{enrollmentId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }
    
    // Global enrollments collection (for admin view)
    match /enrollments/{enrollmentId} {
      // Students can create their own enrollments
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own enrollments
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Admin can read all enrollments
      allow read: if isAdmin();
      
      // Admin can delete enrollments
      allow delete: if isAdmin();
    }
    
    // Course Works collection
    match /courseWorks/{workId} {
      // All authenticated users can read course works
      allow read: if isSignedIn();
      
      // Teachers and admins can create course works
      allow create: if isTeacher() || isAdmin();
      
      // Teachers can update/delete their own works, admins can update/delete any
      allow update, delete: if isAdmin() || 
                             (isTeacher() && resource.data.teacherId == request.auth.uid);
    }
    
    // Submissions collection
    match /submissions/{submissionId} {
      // Students can read their own submissions
      allow read: if isSignedIn() && resource.data.studentId == request.auth.uid;
      
      // Teachers and admins can read all submissions
      allow read: if isTeacher() || isAdmin();
      
      // Students can create their own submissions
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      
      // Students can update their own submissions (before grading)
      allow update: if isStudent() && 
                    resource.data.studentId == request.auth.uid && 
                    resource.data.status == "submitted";
      
      // Teachers can update submissions to grade them
      allow update: if isTeacher() || isAdmin();
      
      // Admin can delete submissions
      allow delete: if isAdmin();
    }
  }
}
